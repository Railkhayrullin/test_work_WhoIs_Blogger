Со сложными запросами к БД пока проблемы, поэтому начал проходить курс по SQL и в течение недели подтяну знания в этой области.

А) какую сумму в среднем в месяц тратит:
- пользователи в возрастном диапазоне от 18 до 25 лет включительно
- пользователи в возрастном диапазоне от 26 до 35 лет включительно
SELECT round(SUM(res_1.sum_purchases) / (res_1.users * res_3.count_year_month), 1) AS users_from_18_to_25_years,
	   round(SUM(res_2.sum_purchases) / (res_2.users * res_3.count_year_month), 1) AS users_from_26_to_35_years
FROM
	(SELECT COUNT(purchase_id) * items.price AS sum_purchases, COUNT(DISTINCT(user_id)) AS users
	FROM items
	INNER JOIN purchases USING (item_id)
	INNER JOIN users USING (user_id)
	WHERE age BETWEEN 18 AND 25
	GROUP BY purchases.item_id, items.price) res_1,

	(SELECT COUNT(purchase_id) * items.price AS sum_purchases, COUNT(DISTINCT(user_id)) AS users
	FROM items
	INNER JOIN purchases USING (item_id)
	INNER JOIN users USING (user_id)
	WHERE age BETWEEN 26 AND 35
	GROUP BY purchases.item_id, items.price) res_2,

        (SELECT COUNT(DISTINCT(date_trunc('YEAR', date))) * COUNT(DISTINCT(date_trunc('MONTH', date))) AS count_year_month
	 FROM purchases) res_3
GROUP BY res_3.count_year_month, res_1.users, res_2.users;

Б) в каком месяце года выручка от пользователей в возрастном диапазоне 35+ самая большая

SELECT month_ AS month_with_max_cash_for_age_35_up, cash
FROM (SELECT date_trunc('MONTH', date) AS month_, SUM(price) AS cash
      FROM items
      INNER JOIN purchases USING (item_id)
      INNER JOIN users USING (user_id)
      WHERE age >= 35
      GROUP BY 1) res_1
WHERE cash = (SELECT MAX(cash)
              FROM (SELECT SUM(price) AS cash, date_trunc('MONTH', date)
	            FROM items
	  	    INNER JOIN purchases USING (item_id)
	            INNER JOIN users USING (user_id)
	            WHERE age >= 35
		    GROUP BY 2) res_2);

В) какой товар дает наибольший вклад в выручку за последний год
SELECT max_ontribution_in_latest_year_item_id, sum_price
FROM (SELECT purchases.item_id AS max_ontribution_in_latest_year_item_id, SUM(price) AS sum_price
      FROM items
      INNER JOIN purchases USING (item_id)
      INNER JOIN users USING (user_id)
      WHERE quote_nullable(date) LIKE '%2020%'
      GROUP BY 1) res_1
WHERE sum_price = (SELECT MAX(sum_price)
				   FROM (SELECT purchases.item_id AS item, SUM(price) AS sum_price
	 			         FROM items
					 INNER JOIN purchases USING (item_id)
	 			         INNER JOIN users USING (user_id)
					 WHERE quote_nullable(date) LIKE '%2020%'
					 GROUP BY 1) res_2);

Г) топ-3 товаров по выручке и их доля в общей выручке за любой год
SELECT res_1.item_id, res_1.sum_price AS sum_price_2018, res_1.sum_price / (res_2.total_price / 100) AS share_of_revenue
FROM (SELECT purchases.item_id AS item_id, SUM(price) AS sum_price
      FROM items
      INNER JOIN purchases USING (item_id)
      INNER JOIN users USING (user_id)
      WHERE quote_nullable(date) LIKE '%2018%'
      GROUP BY 1
      ORDER BY 1 DESC LIMIT 3) res_1,
      
     (SELECT SUM(price) AS total_price
      FROM items
      INNER JOIN purchases USING (item_id)
      INNER JOIN users USING (user_id)
      WHERE quote_nullable(date) LIKE '%2018%') res_2;
